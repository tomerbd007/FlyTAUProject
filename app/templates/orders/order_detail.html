{% extends "base.html" %}

{% block title %}Order {{ order.booking_code }} - FLYTAU{% endblock %}

{% block content %}
<style>
    .order-shell {
        display: flex;
        min-height: calc(100vh - 150px);
        position: relative;
    }

    .order-shell::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 45%;
        height: 100%;
        background: linear-gradient(135deg, #1a3a52 0%, #2d5a7b 100%);
        z-index: 0;
    }

    .order-card {
        display: flex;
        width: 100%;
        position: relative;
        z-index: 1;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.14);
        border-radius: 18px;
        overflow: hidden;
        background: transparent;
    }

    .order-sidebar {
        width: 45%;
        padding: 60px 40px;
        color: #f8fbff;
        display: flex;
        flex-direction: column;
        gap: 18px;
        justify-content: center;
    }

    .order-sidebar .logo { font-size: 2.4rem; font-weight: 700; letter-spacing: -1px; }
    .order-sidebar h1 { margin: 0; font-size: 1.8rem; font-weight: 600; }
    .order-sidebar p { margin: 0; opacity: 0.9; line-height: 1.6; }

    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,0.12);
        font-weight: 700;
        text-transform: capitalize;
    }
    .status-confirmed { color: #baf3c0; }
    .status-cancelled { color: #ffd6d6; }
    .status-active { color: #c8e1ff; }

    .order-sidebar .meta {
        display: grid;
        gap: 10px;
        margin-top: 10px;
        font-size: 0.95rem;
    }

    .order-main {
        width: 55%;
        background: #ffffff;
        padding: 50px 48px;
        display: flex;
        flex-direction: column;
        gap: 22px;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
    .order-header .title { margin: 0; color: #1a3a52; font-size: 1.6rem; }
    .order-header .back-link { color: #1a3a52; text-decoration: none; font-weight: 600; }

    .card {
        border: 1px solid #e7edf5;
        border-radius: 14px;
        padding: 18px;
        background: #fbfdff;
        box-shadow: 0 10px 24px rgba(0,0,0,0.04);
    }
    .card h2 { margin: 0 0 12px; color: #1a3a52; }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 14px;
    }
    .info-item { display: grid; gap: 4px; }
    .info-item .label { color: #6b7b8c; font-weight: 600; font-size: 0.9rem; }
    .info-item .value { color: #1a3a52; font-weight: 700; }

    .flight-route {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        align-items: center;
    }
    .route-point { display: grid; gap: 4px; }
    .route-point .time { font-weight: 700; color: #1a3a52; }
    .route-point .city { font-weight: 600; }
    .route-point .date { color: #6b7b8c; font-size: 0.9rem; }
    .route-line { text-align: center; color: #6b7b8c; font-weight: 700; }

    .tickets-table { width: 100%; border-collapse: collapse; }
    .tickets-table th, .tickets-table td { padding: 10px 12px; border-bottom: 1px solid #e7edf5; text-align: left; }
    .ticket-status { padding: 6px 10px; border-radius: 12px; background: #eef3ff; color: #2c4fa1; font-weight: 700; font-size: 0.9rem; text-transform: capitalize; }
    .status-cancelled .ticket-status { background: #fdeeee; color: #c0392b; }

    .payment-breakdown { display: grid; gap: 10px; }
    .payment-row { display: flex; justify-content: space-between; color: #1a3a52; }
    .payment-row.total { font-weight: 700; font-size: 1.05rem; }
    .payment-row.refund { color: #c0392b; }

    .actions { display: grid; gap: 10px; margin-top: 6px; }
    .btn-block { display: block; width: 100%; text-align: center; padding: 12px 14px; border-radius: 10px; text-decoration: none; font-weight: 700; }
    .btn-danger { background: #c0392b; color: #fff; }
    .btn-muted { background: #f2f4f8; color: #6b7b8c; }

    @media (max-width: 1024px) {
        .order-shell::before { width: 100%; height: 240px; }
        .order-card { flex-direction: column; border-radius: 0; box-shadow: none; }
        .order-sidebar { width: 100%; padding: 40px 28px; text-align: center; }
        .order-main { width: 100%; padding: 32px 24px; margin-top: -20px; border-radius: 20px 20px 0 0; }
        .flight-route { grid-template-columns: 1fr; }
        .order-header { flex-direction: column; align-items: flex-start; }
    }

    @media (max-width: 640px) {
        .info-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="order-shell">
    <div class="order-card">
        <div class="order-sidebar">
            <div class="logo">FLYTAU</div>
            <h1>Order {{ order.booking_code }}</h1>
            {% set display_status = 'cancelled' if order.status in ['customer_canceled', 'system_canceled'] else order.status %}
            <div class="status-pill status-{{ display_status }}">{{ display_status|capitalize }}</div>
            <div class="meta">
                <div><strong>Email:</strong> {{ order.email }}</div>
                <div><strong>Date:</strong> {{ order.created_at.strftime('%b %d, %Y %H:%M') }}</div>
                <div><strong>Flight:</strong> {{ order.flight_number }}</div>
            </div>
            <p>Review your itinerary, tickets, and payment summary. For changes or issues, contact our support team.</p>
        </div>

        <div class="order-main">
            <div class="order-header">
                <h2 class="title">Order Details</h2>
                {% if is_guest %}
                <a href="{{ url_for('guest_lookup') }}" class="back-link">← Back to Guest Lookup</a>
                {% else %}
                <a href="{{ url_for('my_orders') }}" class="back-link">← Back to My Orders</a>
                {% endif %}
            </div>
            
            {% if order.status in ['customer_canceled', 'system_canceled'] %}
            <div class="card" style="background: #fdeeee; border-color: #f5c6cb;">
                <h2 style="color: #c0392b;">Booking Cancelled</h2>
                {% if order.status == 'system_canceled' %}
                <p>This booking was cancelled by the airline. You have received a <strong>full refund</strong>.</p>
                {% else %}
                <p>You cancelled this booking. A 5% cancellation fee was applied.</p>
                {% endif %}
            </div>
            {% endif %}

            <div class="card">
                <h2>Booking Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Booking Code</span>
                        <span class="value">{{ order.booking_code }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Order Date</span>
                        <span class="value">{{ order.created_at.strftime('%B %d, %Y at %H:%M') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Email</span>
                        <span class="value">{{ order.email }}</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Flight Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Flight</span>
                        <span class="value">{{ order.flight_number }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Aircraft</span>
                        <span class="value">{{ order.aircraft_type }}</span>
                    </div>
                </div>
                <div class="flight-route">
                    <div class="route-point">
                        <span class="time">{{ order.departure_time.strftime('%H:%M') }}</span>
                        <span class="city">{{ order.origin }}</span>
                        <span class="date">{{ order.departure_time.strftime('%a, %b %d, %Y') }}</span>
                    </div>
                    <div class="route-line">{{ order.duration_minutes // 60 }}h {{ order.duration_minutes % 60 }}m</div>
                    <div class="route-point">
                        <span class="time">{{ order.arrival_time.strftime('%H:%M') }}</span>
                        <span class="city">{{ order.destination }}</span>
                        <span class="date">{{ order.arrival_time.strftime('%a, %b %d, %Y') }}</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Tickets</h2>
                <table class="tickets-table">
                    <thead>
                        <tr>
                            <th>Seat</th>
                            <th>Class</th>
                            <th>Status</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr>
                            <td><strong>{{ ticket.seat_number }}</strong></td>
                            <td>{{ ticket.seat_class|capitalize }}</td>
                            <td><span class="ticket-status">{{ ticket.status|capitalize }}</span></td>
                            <td>${{ "%.2f"|format(ticket.price) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Payment Summary</h2>
                <div class="payment-breakdown">
                    {% if order.status == 'system_canceled' %}
                    {# System cancellation - full refund, TotalCost is 0 #}
                    <div class="payment-row">
                        <span>Original Amount</span>
                        <span>Refunded</span>
                    </div>
                    <div class="payment-row total" style="color: #27ae60;">
                        <span>Full Refund Issued</span>
                        <span>$0.00 due</span>
                    </div>
                    {% elif order.status == 'customer_canceled' %}
                    {# Customer cancellation - TotalCost is the 5% fee (final paid amount) #}
                    {# Calculate original amount from fee: original = fee / 0.05 #}
                    {% set cancellation_fee = order.total_amount %}
                    {% set original_amount = cancellation_fee / 0.05 %}
                    {% set refund_amount = original_amount - cancellation_fee %}
                    <div class="payment-row">
                        <span>Original Amount</span>
                        <span>${{ "%.2f"|format(original_amount) }}</span>
                    </div>
                    <div class="payment-row" style="color: #c0392b;">
                        <span>Cancellation Fee (5%)</span>
                        <span>${{ "%.2f"|format(cancellation_fee) }}</span>
                    </div>
                    <div class="payment-row" style="color: #27ae60;">
                        <span>Refund Amount (95%)</span>
                        <span>${{ "%.2f"|format(refund_amount) }}</span>
                    </div>
                    <div class="payment-row total">
                        <span>Final Cost Paid</span>
                        <span>${{ "%.2f"|format(cancellation_fee) }}</span>
                    </div>
                    {% else %}
                    {# Active/confirmed order #}
                    <div class="payment-row">
                        <span>Tickets ({{ tickets|length if tickets else 0 }})</span>
                        <span>${{ "%.2f"|format(order.total_amount) }}</span>
                    </div>
                    <div class="payment-row total">
                        <span>Total Paid</span>
                        <span>${{ "%.2f"|format(order.total_amount) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if order.status == 'confirmed' %}
            <div class="card">
                <h2>Order Actions</h2>
                <div class="actions">
                    {% if order.can_cancel %}
                        {% if is_guest %}
                        <a href="{{ url_for('guest_cancel_order', booking_code=order.booking_code) }}?email={{ order.email }}" class="btn-block btn-danger">Cancel Order</a>
                        {% else %}
                        <a href="{{ url_for('customer_cancel_order', booking_code=order.booking_code) }}" class="btn-block btn-danger">Cancel Order</a>
                        {% endif %}
                        {% if order.cancel_deadline %}
                        <p class="action-note">You can cancel until {{ order.cancel_deadline.strftime('%b %d at %H:%M') }}</p>
                        {% endif %}
                    {% else %}
                    <div class="btn-block btn-muted">Cancellation unavailable</div>
                    <p class="action-note" style="color:#6b7b8c;">Less than 36 hours to departure.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            <div class="card">
                <h2>Need Help?</h2>
                <p>Contact our support team:</p>
                <p><strong>support@flytau.com</strong></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
